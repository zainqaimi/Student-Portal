<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Student Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4 bg-light">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
      <h2>ðŸŽ“ Student Dashboard</h2>
      <button id="logoutBtn" class="btn btn-danger">Logout</button>
    </div>

    <!-- âœ… Profile -->
    <div class="card p-3 mb-4 shadow-sm">
      <h4>My Profile</h4>
      <p><b>Name:</b> <span id="studentName">Loading...</span></p>
      <p><b>Email:</b> <span id="studentEmail">Loading...</span></p>
      <p><b>CampusId:</b> <span id="studentCampus">Loading...</span></p>
      <p><b>Status:</b> <span id="studentStatus" class="badge bg-secondary">Loading...</span></p>
      <button id="downloadIdBtn" class="btn btn-outline-primary btn-sm mt-2">ðŸªª Download ID Card (PDF)</button>
    </div>

    <!-- âœ… Course Enrollment -->
    <div class="card p-3 shadow-sm">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4>Available Courses</h4>
        <small class="text-muted">Enroll only if allowed</small>
      </div>
      <table class="table table-bordered">
        <thead class="table-light">
          <tr>
            <th>Course Name</th>
            <th>Description</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="coursesTable"></tbody>
      </table>
    </div>
  </div>

  <!-- âœ… Firebase + jsPDF + QR -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
    import { 
      getFirestore, doc, getDoc, collection, getDocs, updateDoc, arrayUnion 
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCAAlLARl0EFxQy2Z3SW8eX9uXGLNYkRWY",
      authDomain: "studentportal-27f0e.firebaseapp.com",
      projectId: "studentportal-27f0e",
      storageBucket: "studentportal-27f0e.appspot.com",
      messagingSenderId: "720954283815",
      appId: "1:720954283815:web:0c51933a3f8631f58dfb02"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const nameEl = document.getElementById("studentName");
    const emailEl = document.getElementById("studentEmail");
    const campusEl = document.getElementById("studentCampus");
    const statusEl = document.getElementById("studentStatus");
    const tableBody = document.getElementById("coursesTable");

    let currentStudentId = null;
    let currentStudentData = null;

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "auth.html";
        return;
      }

      try {
        const userRef = doc(db, "users", user.uid);
        const userSnap = await getDoc(userRef);

        if (!userSnap.exists()) {
          console.warn("âš ï¸ User doc not found in 'users' for UID:", user.uid);
          alert("User record not found!");
          return;
        }

        const userData = userSnap.data();
        console.log("ðŸ‘¤ User Data:", userData);

        if (userData.role !== "student") {
          alert("Unauthorized Access!");
          window.location.href = "auth.html";
          return;
        }

        currentStudentId = user.uid;

        // âœ… Fetch student document
        const studentRef = doc(db, "students", user.uid);
        const snap = await getDoc(studentRef);

        if (!snap.exists()) {
          console.warn("âš ï¸ Student doc not found for UID:", user.uid);

          // Debug: List all student IDs
          const allStudents = await getDocs(collection(db, "students"));
          console.log("ðŸ“‹ All Student IDs:", allStudents.docs.map(d => d.id));

          alert("Student record not found! Check console for details.");
          return;
        }

        currentStudentData = snap.data();
        console.log("âœ… Student Data Found:", currentStudentData);

        // âœ… Update profile UI
        nameEl.innerText = currentStudentData.name || "Not Available";
        emailEl.innerText = currentStudentData.email || user.email;
        campusEl.innerText = currentStudentData.campusId || "-";
        statusEl.innerText = currentStudentData.status || "pending";
        statusEl.className = `badge ${
          currentStudentData.status === "active" ? "bg-success" : "bg-warning text-dark"
        }`;

        // Load courses
        await loadCourses();

      } catch (err) {
        console.error("ðŸ”¥ Error in student dashboard:", err);
        alert("Something went wrong while loading data. Check console for details.");
      }
    });

    // âœ… Logout
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "auth.html";
    });

    // âœ… Load available courses
    async function loadCourses() {
      const snap = await getDocs(collection(db, "courses"));
      tableBody.innerHTML = "";
      snap.forEach(courseDoc => {
        const c = courseDoc.data();
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${c.name}</td>
          <td>${c.description || "-"}</td>
          <td>
            <button class="btn btn-sm btn-primary enrollBtn" data-id="${courseDoc.id}">
              Enroll
            </button>
          </td>
        `;
        tableBody.appendChild(row);
      });

      document.querySelectorAll(".enrollBtn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const courseId = btn.getAttribute("data-id");
          if (currentStudentData.status !== "active") {
            alert("You cannot enroll until your account is active!");
            return;
          }

          const studentRef = doc(db, "students", currentStudentId);
          await updateDoc(studentRef, {
            courses: arrayUnion({
              courseId: courseId,
              status: "enrolled",
              enrolledAt: new Date().toISOString()
            })
          });
          alert("âœ… Course enrolled successfully!");
        });
      });
    }

    // âœ… ID card download with QR
    document.getElementById("downloadIdBtn").addEventListener("click", async () => {
      if (!currentStudentData) {
        alert("Please wait, data not loaded yet!");
        return;
      }

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();

      const profileUrl = `${window.location.origin}/profile.html?id=${currentStudentId}`;

      // Generate QR code temporarily
      const qrDiv = document.createElement("div");
      new QRCode(qrDiv, { text: profileUrl, width: 100, height: 100 });
      const qrCanvas = qrDiv.querySelector("canvas");
      const qrDataURL = qrCanvas.toDataURL();

      pdf.setFontSize(16);
      pdf.text("Student ID Card", 70, 20);
      pdf.setFontSize(12);
      pdf.text(`Name: ${currentStudentData.name}`, 20, 40);
      pdf.text(`Email: ${currentStudentData.email}`, 20, 50);
      pdf.text(`Campus ID: ${currentStudentData.campusId}`, 20, 60);
      pdf.text(`Status: ${currentStudentData.status}`, 20, 70);
      pdf.text(`Student ID: ${currentStudentData.studentId}`, 20, 80);
      pdf.addImage(qrDataURL, "PNG", 150, 40, 40, 40);

      pdf.save(`${currentStudentData.name}_ID.pdf`);
    });
  </script>
</body>
</html>
