<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .dashboard-card {
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .dashboard-card:hover {
      transform: scale(1.03);
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body class="p-4 bg-light">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
      <h2>Welcome Super Admin ðŸ‘‘</h2>
      <div class="d-flex flex-wrap gap-2">
        <a href="addstudent.html" class="btn btn-primary">âž• Add Student</a>
        <a href="addcampus.html" class="btn btn-outline-primary">Add Campus</a>
        <a href="addcourse.html" class="btn btn-outline-success">Add Course</a>
        <button id="logoutBtn" class="btn btn-danger">Logout</button>
      </div>
    </div>

    <p class="text-muted">Yahan se aap campuses, courses aur students manage kar sakte hain.</p>

    <!-- âœ… Dashboard Summary -->
    <div class="row text-center mt-4">
      <div class="col-md-4 mb-3">
        <div class="card dashboard-card shadow-sm p-3" id="studentsCard">
          <h5>Total Students</h5>
          <h3 id="studentsCount">0</h3>
        </div>
      </div>
      <div class="col-md-4 mb-3">
        <div class="card dashboard-card shadow-sm p-3" id="coursesCard">
          <h5>Total Courses</h5>
          <h3 id="coursesCount">0</h3>
        </div>
      </div>
      <div class="col-md-4 mb-3">
        <div class="card dashboard-card shadow-sm p-3" id="campusesCard">
          <h5>Total Campuses</h5>
          <h3 id="campusesCount">0</h3>
        </div>
      </div>
    </div>

    <!-- âœ… Student Approval Section -->
    <div class="mt-5">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4>Manage Students</h4>
        <select id="filterStatus" class="form-select w-auto">
          <option value="all">All Students</option>
          <option value="pending">Pending</option>
          <option value="approved">Approved</option>
        </select>
      </div>

      <table class="table table-bordered table-striped">
        <thead class="table-light">
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Campus</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="studentsTable"></tbody>
      </table>
    </div>
  </div>

  <script type="module">
    import { 
      initializeApp 
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { 
      getAuth, 
      onAuthStateChanged, 
      signOut 
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
    import { 
      getFirestore, 
      collection, 
      getDocs, 
      query, 
      where, 
      updateDoc, 
      doc, 
      getDoc 
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCAAlLARl0EFxQy2Z3SW8eX9uXGLNYkRWY",
      authDomain: "studentportal-27f0e.firebaseapp.com",
      projectId: "studentportal-27f0e",
      storageBucket: "studentportal-27f0e.appspot.com",
      messagingSenderId: "720954283815",
      appId: "1:720954283815:web:0c51933a3f8631f58dfb02"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // âœ… Auth Check
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        const userRef = doc(db, "users", user.uid);
        const userSnap = await getDoc(userRef);
        if (!userSnap.exists()) return alert("User data not found!");

        const data = userSnap.data();
        if (data.role !== "superadmin") {
          alert("Unauthorized Access!");
          window.location.href = "auth.html";
          return;
        }

        console.log("Super Admin verified âœ…");
        loadDashboardCounts();
        loadStudents();

      } else {
        window.location.href = "auth.html";
      }
    });

    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "auth.html";
    });

    // âœ… Dashboard counts
    async function loadDashboardCounts() {
      const studentsSnap = await getDocs(collection(db, "students"));
      const coursesSnap = await getDocs(collection(db, "courses"));
      const campusesSnap = await getDocs(collection(db, "campuses"));

      document.getElementById("studentsCount").innerText = studentsSnap.size;
      document.getElementById("coursesCount").innerText = coursesSnap.size;
      document.getElementById("campusesCount").innerText = campusesSnap.size;
    }

    // âœ… Clickable cards navigation
    document.getElementById("studentsCard").addEventListener("click", () => {
      window.location.href = "students_list.html";
    });
    document.getElementById("coursesCard").addEventListener("click", () => {
      window.location.href = "courses.html";
    });
    document.getElementById("campusesCard").addEventListener("click", () => {
      window.location.href = "campuses.html";
    });

    // âœ… Student List + Filter + Approve
    const studentsTable = document.getElementById("studentsTable");
    const filterSelect = document.getElementById("filterStatus");

    async function loadStudents() {
      studentsTable.innerHTML = "<tr><td colspan='5'>Loading...</td></tr>";
      let q;

      if (filterSelect.value === "pending") {
        q = query(collection(db, "students"), where("status", "==", "pending"));
      } else if (filterSelect.value === "approved") {
        q = query(collection(db, "students"), where("status", "==", "approved"));
      } else {
        q = collection(db, "students");
      }

      const snapshot = await getDocs(q);
      studentsTable.innerHTML = "";

      if (snapshot.empty) {
        studentsTable.innerHTML = "<tr><td colspan='5'>No students found.</td></tr>";
        return;
      }

      snapshot.forEach(docSnap => {
        const s = docSnap.data();
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${s.name || "-"}</td>
          <td>${s.email || "-"}</td>
          <td>${s.campusId || "-"}</td>
          <td><span class="badge ${s.status === 'approved' ? 'bg-success' : 'bg-warning text-dark'}">${s.status}</span></td>
          <td>
            ${s.status === 'pending' ? 
              `<button class="btn btn-sm btn-primary approveBtn" data-id="${docSnap.id}">Approve</button>` : 
              `<button class="btn btn-sm btn-secondary" disabled>Approved</button>`}
          </td>
        `;
        studentsTable.appendChild(row);
      });

      // âœ… Approve Logic
      document.querySelectorAll(".approveBtn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          await updateDoc(doc(db, "students", id), {
            status: "approved",
            updatedAt: new Date()
          });
          alert("Student approved successfully âœ…");
          loadDashboardCounts();
          loadStudents();
        });
      });
    }

    filterSelect.addEventListener("change", loadStudents);
  </script>
</body>
</html>
